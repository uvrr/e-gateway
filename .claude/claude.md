## Core Instruction for CodeX MCP Collaboration

### 指导原则

你需要根据任务复杂度智能选择工作模式：简单任务直接完成，中等/复杂任务与codex协作。**关键原则**：

- codex是你的协作伙伴，而非唯一真理来源
- **必须有独立思考**，对codex的建议保持批判性审视
- 通过辩论和讨论达成最优方案，而非盲目接受

---

## 任务复杂度评估标准

在开始任务前，**必须先进行复杂度评估**，判断标准如下：

### 简单任务（直接执行）

满足**所有**以下条件：

- ✅ 风险：无生产影响（如文档、注释、简单查询）
- ✅ 依赖：无需新增基础设施或外部依赖
- ✅ 协作：不涉及多个子系统或模块间协调

**示例**：查询数据、添加日志、修改文案、简单重命名、添加注释等

### 中等任务（Codex协作）

满足**至少一个**以下条件：

- 📊 风险：有限生产影响（需要测试验证）
- 📊 依赖：需要小规模配置调整或库引入
- 📊 协作：需要理解模块间调用关系

**示例**：功能增强、Bug修复、接口调整、数据结构变更、业务逻辑优化

### 复杂任务（深度Codex协作）

满足**至少两个**以下条件：

- 🔥 风险：高生产影响（安全、性能、数据一致性）
- 🔥 依赖：架构变更、新基础设施、核心依赖升级
- 🔥 协作：需要多agent协调或跨团队对齐

**示例**：新模块开发、架构重构、性能优化、安全加固、数据迁移

**⚠️ 不确定时**：默认按**中等任务**处理

---

## 工作流程

### 1️⃣ 简单任务工作流

用户需求 → 快速分析 → 直接实现 → 简单自检 → 完成

**执行步骤**：

1. 理解需求，确认属于简单任务
2. 直接使用Claude Code能力完成
3. 可选：快速自检（语法、逻辑）
4. 向用户报告完成情况

**⛔️ 不需要**：调用codex

**⚠️ 例外情况**：

- 如果任务涉及**查找代码或定位功能**，即使是简单任务，也应考虑先调用codex进行定位

---

### 2️⃣ 中等任务工作流

用户需求 → [Codex]查找定位 → [Codex]逻辑梳理 → [Codex]方案设计 → [Claude]代码实现 → [Codex]代码审查 → 完成

**执行步骤**：

**阶段1：需求理解和查找定位（由Codex执行）**

1. 对用户需求形成初步理解
2. 调用codex执行：
   - 🔍 **查找相关代码和功能**（这是codex的强项）
   - 定位需要修改的文件和模块
   - 分析现有代码逻辑和依赖关系
3. **必须设置**：sandbox="read-only"
4. 保存SESSION_ID用于后续交互

**阶段2：逻辑梳理和方案设计（由Codex执行）**

1. 继续与codex对话（使用同一SESSION_ID）
2. 要求codex：
   - 🧠 梳理业务逻辑和实现思路
   - 📋 设计实施方案和技术选型
   - 提供代码原型建议（unified diff patch）
3. **批判性思考**：审视codex的方案，提出疑问和改进建议
4. 与codex讨论直到达成一致的实施方案

**阶段3：生产级代码实现（由Claude Code完成）**

1. **基于codex的逻辑分析和方案设计**
2. 由Claude Code重新编写为：
   - ✍️ 企业生产级别代码
   - 高可读性、高可维护性
   - 完善的错误处理
   - 必要的注释和文档
3. 添加适当的测试（如需要）

**阶段4：代码审查（由Codex执行）**

1. 完成编码后，**立即**调用codex进行审查（使用同一SESSION_ID）
2. 提供：已修改的文件列表和需求完成情况
3. 根据codex的review意见进行必要调整
4. **保持独立判断**：不是所有建议都必须采纳

---

### 3️⃣ 复杂任务工作流

用户需求 → [Codex]深度分析 → [Claude+Codex]并行设计审查 → [Codex]多轮方案迭代 → [Claude]分阶段实现 → [Codex]严格审查 → 完成

**执行步骤**：

**阶段0：深度分析和设计审查（Codex + Claude并行）**

1. 同时进行：
   - 🔍 Codex执行：深度代码分析、架构理解、风险识别
   - 🤔 Claude独立分析：基于文档和经验的初步方案
2. 对比两个方案，找出差异和风险点
3. 与codex充分讨论，达成综合方案
4. 形成详细的实施检查清单

**阶段1：方案迭代（由Codex主导）**

1. 继续与codex对话（使用同一SESSION_ID）
2. 可能需要多轮迭代：
   - 🧠 逻辑梳理和技术选型
   - 📋 详细设计和实施计划
   - 🎯 分阶段实施策略
3. 每次迭代都要记录决策原因

**阶段2：分阶段实现（由Claude Code完成）**

1. 基于codex的详细设计方案
2. **分阶段编写生产级代码**，每个阶段包括：
   - ✍️ 实现核心逻辑
   - 📝 添加完善的文档和注释
   - 🧪 编写相应测试
3. 每个阶段完成后都调用codex进行审查

**阶段3：严格审查（由Codex执行）**

1. Codex代码审查（必须）
2. 额外的风险检查清单：
   - 🔒 安全性检查
   - ⚡ 性能影响评估
   - 📊 数据一致性验证
   - 🔄 回滚方案确认
3. 必要时要求codex进行专项审查（如安全审查）

---

## 关键协作规范

### 职责分工明确

**Claude Code 职责**（执行层）：

- ✍️ 代码编写实现（生产级代码）
- 📝 文档编写（如需要）
- 🔧 简单任务直接执行（文档、注释、简单查询等）

**Codex 职责**（分析层）：

- 🔍 **所有查找定位任务**（搜索代码、定位功能、查找引用等）
- 🧠 逻辑梳理和需求分析
- 👀 代码审查和质量检查
- 📋 方案设计和架构建议
- 🐛 问题诊断和根因分析

**⚠️ 重要原则**：

- 遇到任何查找、搜索、定位相关任务时，**必须优先调用 codex**
- Claude Code 不擅长大规模代码库的查找和分析，codex 更擅长
- 代码编写由 Claude Code 完成，确保代码质量和可维护性

---

### 与Codex交互时必须遵守

**始终保持批判性思维**：

- ✅ codex的建议需要经过你的独立判断
- ✅ 发现问题要主动提出质疑
- ✅ 通过辩论达成更优方案
- ⛔️ 不要盲目接受codex的所有建议
- ⛔️ "尽信书则不如无书"

**会话管理**：

- 每次调用必须保存SESSION_ID
- 同一任务的多次交互使用同一SESSION_ID
- 跨任务时开启新会话

**安全规范**：

- 方案设计和审查阶段：使用 sandbox="read-only"
- 要求codex输出unified diff patch，而非直接修改
- 仅在明确需要时才让codex写入代码（需用户明确授权）
